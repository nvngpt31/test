#!/bin/bash

  ucmhome='/opt/ucm'
  ucmuser='zsmeucm'
  ucmrepo="http://gitlab.associatesys.local/tools/ucm.git"
  branch='beta'
  moddir="/etc/puppetlabs/code/environments/production/modules"
  pconfdir="/etc/puppetlabs/puppet"
  hieraconf="${pconfdir}/hiera.yaml"
  hieradir="/etc/puppetlabs/code/environments/production/hieradata"
  ucmmainfiledir="${moddir}/ucm/files/main"
  ucmbindir="${moddir}/ucm/files/bin/sme"
  localbin="/usr/local/bin"
  factsdir="/etc/facter/facts.d"

  echo 'is_halo=true'       > ${factsdir}/is_halo.txt
  echo 'is_masterless=true' > ${factsdir}/is_masterless.txt

  if [[ ! -d ${moddir}/ucm ]]
  then echo "...ATTEMPTING TO CLONE UCM REPO"      ; echo ""
       cd $moddir && git clone -b $branch $ucmrepo ; echo ""
  fi

  cp ${ucmmainfiledir}/hiera.yaml  $pconfdir
  cp ${ucmmainfiledir}/common.yaml $hieradir
  cp ${ucmbindir}/ucm              $localbin
  chmod 0775 ${localbin}/ucm
  cd $hieradir && ln -s $moddir

  id $ucmuser >/dev/null 2>&1
  if [[ $? != '0' ]] ; then
    mkdir -p $ucmhome
    useradd $ucmuser -d $ucmhome >/dev/null 2>&1

    if [[ $? != '0' ]]
    then echo "...FAILED ADDING UCMUSER, BAILING" ; exit 1
    else chown -R ${ucmuser}.users $ucmhome
         # need to configure ssh dir here
         usermod -a -G root zsmeucm
         echo "...ADDED UCM USER"
    fi
  fi

